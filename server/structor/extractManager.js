"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n.default=e,n}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function getNamespacesInPages(e,n,t){var o=[];if(t&&t.length>0&&n&&n.pages){var a=[];if(n.pages.forEach(function(n){(0,_lodash.includes)(t,n.pagePath)&&(a=a.concat(_utils.gengine.getModelComponentList(e,n)))}),a&&a.length>0){var r=a.filter(function(e){return!e.namespace});if(r&&r.length>0)throw Error("Selected pages are including components out of any namespace.");a.forEach(function(e){(0,_lodash.includes)(o,e.namespace)||o.push(e.namespace)})}}return o}function getDependentNamespaces(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],a=[];t=t.concat(n);var r=_utils.gengine.combineAllModulesComponents(e,n),s=_utils.gengine.getModelComponentList(e,r);if(s&&s.length>0){var i=s.filter(function(e){return!e.namespace});if(i&&i.length>0)throw Error("Component models are including components out of any namespace.");s.forEach(function(e){(0,_lodash.includes)(t,e.namespace)||(0,_lodash.includes)(a,e.namespace)||a.push(e.namespace)})}return _utils.gengine.getModulesImports(e,n).then(function(n){return n&&n.length>0&&n.forEach(function(e){e&&!(0,_lodash.isEmpty)(e)&&(0,_lodash.forOwn)(e,function(e,n){var r=e.source;if(r&&r.length>0){var s=r.replace(/\\/g,"/");if(0!==r.indexOf(".")){var i=s.split("/");i&&i.length>0&&("modules"===i[0]?(0,_lodash.includes)(t,i[1])||(0,_lodash.includes)(a,i[1])||a.push(i[1]):(0,_lodash.includes)(o,i[0])||o.push(i[0]))}}})}),a.length>0?getDependentNamespaces(e,a,t,o):{depNamespaces:t,modules:o}})}function getAllDependencies(e,n){var t={dependencies:{packages:[]}},o=void 0;return _utils.storage.getComponentTree().then(function(e){return o=e,_utils.storage.readProjectJsonModel()}).then(function(e){return getNamespacesInPages(o,e,n)}).then(function(n){return getDependentNamespaces(o,[].concat(e,n))}).then(function(e){var n=e.depNamespaces,o=e.modules;t.namespaces=n;var a=[];return o&&o.length>0&&o.forEach(function(e){a.push(_utils.commons.getPackageVersion(e,_utils.config.getProjectDir()).then(function(n){n&&t.dependencies.packages.push({name:e,version:n})}).catch(function(e){console.error(e)}))}),Promise.all(a).then(function(){return t})})}function extractNamespaces(e,n,t,o){var a=_utils.config.sandboxGeneratorDirPath(),r=_path2.default.join(_utils.config.sandboxDirPath(),"modules"),s=o,i=_path2.default.join(s,"modules"),u=_path2.default.join(s,"defaults"),c=_path2.default.join(s,"docs"),l=_path2.default.join(s,".structor"),p={namespaces:e,project:_utils.config.getProjectConfig()},d=void 0,f={namespaces:{},dependencies:n},h=void 0;return _utils.storage.getComponentTree().then(function(e){return p.index=e,h=e,gengineManager.process(a,p)}).then(function(e){var n=e.files;return _utils.storage.saveGenerated({},n)}).then(function(){var n=Promise.resolve();return e.forEach(function(e){n=n.then(function(){if(d=h.modules[e],d&&d.absolutePath){var n=d.absolutePath;return _utils.commons.copyFile(n,_path2.default.join(r,e))}})}),n}).then(function(){return sandboxCompilerManager.compileSandbox().catch(function(e){throw Error("It seems that some components include external components out of any namespace.\n\n\n "+e)})}).then(function(){var n=Promise.resolve(),t=h.reducersSourceCode;return e.forEach(function(e){n=n.then(function(){if(d=h.modules[e],d&&d.absolutePath){var n=d.reducerFilePath;if(n){var o=_utils.gengine.getReducerPropertyName(t,d.reducerImportPath);f.namespaces[e]=f.namespaces[e]||{},f.namespaces[e].reducerPropName=o}return _utils.commons.copyFile(d.absolutePath,_path2.default.join(i,e)).then(function(){var n=_path2.default.join(_utils.config.docsComponentsDirPath(),e);return _utils.commons.copyFile(n,_path2.default.join(c,e)).catch(function(e){console.error("Copying docs. ",e)})}).then(function(){var n=_path2.default.join(_utils.config.componentDefaultsDirPath(),e);return _utils.commons.copyFile(n,_path2.default.join(u,e)).catch(function(e){console.error("Copying defaults. ",e)})})}})}),n}).then(function(){if(t&&t.length>0)return _utils.storage.readProjectJsonModel().then(function(e){var n={pages:[]};return e&&e.pages&&e.pages.forEach(function(e){(0,_lodash.includes)(t,e.pagePath)&&n.pages.push(e)}),_utils.commons.writeJson(_path2.default.join(l,"model.json"),n)})}).then(function(){return _utils.commons.writeJson(_path2.default.join(s,"structor-namespaces.json"),f)}).then(function(){return _utils.commons.removeFile(_utils.config.sandboxDirPath())})}Object.defineProperty(exports,"__esModule",{value:!0}),exports.getNamespacesInPages=getNamespacesInPages,exports.getDependentNamespaces=getDependentNamespaces,exports.getAllDependencies=getAllDependencies,exports.extractNamespaces=extractNamespaces;var _path=require("path"),_path2=_interopRequireDefault(_path),_lodash=require("lodash"),_utils=require("../utils"),_gengine=require("../commons/gengine.js"),gengineManager=_interopRequireWildcard(_gengine),_sandboxCompilerManager=require("./sandboxCompilerManager.js"),sandboxCompilerManager=_interopRequireWildcard(_sandboxCompilerManager);